name: Add Benefit from Issue

on:
  issues:
    types: [labeled]

jobs:
  create-pr:
    if: github.event.label.name == 'new-benefit'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Process benefit submission
        id: process
        uses: actions/github-script@v7
        env:
          MODELS_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          result-encoding: string
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            const issueTitle = issue.title || '';

            // Parse optional fields from issue body
            const linkMatch = issueBody.match(/### Link \(optional\)\s*\n\n([^\n]+)/);
            const categoryMatch = issueBody.match(/### Category \(optional\)\s*\n\n([^\n]+)/);
            const userLink = linkMatch ? linkMatch[1].trim() : null;
            const userCategory = categoryMatch && categoryMatch[1].trim() !== '' ? categoryMatch[1].trim() : null;

            const input = issueTitle + '\n' + issueBody;

            const token = process.env.MODELS_TOKEN;
            if (!token) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Missing API token. Please add GH_MODELS_TOKEN secret to the repository.'
              });
              return '';
            }

            // Read current benefits for duplicate checking
            const fs = require('fs');
            const currentBenefits = JSON.parse(fs.readFileSync('src/data/benefits.json', 'utf8'));
            const existingNames = currentBenefits.map(b => b.name.toLowerCase());
            const existingUrls = currentBenefits.map(b => {
              try {
                return new URL(b.link).hostname.replace('www.', '');
              } catch { return ''; }
            });

            const prompt = [
              'You are an assistant that processes student benefit submissions for a directory website.',
              'Users can submit casually - your job is to identify the product and extract/generate the structured data.',
              '',
              'USER SUBMISSION:',
              input,
              '',
              userLink ? 'USER PROVIDED LINK: ' + userLink : '',
              userCategory ? 'USER PROVIDED CATEGORY: ' + userCategory : '',
              '',
              'EXISTING BENEFITS (check for duplicates):',
              existingNames.join(', '),
              '',
              'EXISTING DOMAINS (check for duplicates):',
              existingUrls.filter(Boolean).join(', '),
              '',
              'YOUR TASK:',
              '1. Identify what product/service the user is referring to (even from casual/brief descriptions)',
              '2. Check if this is a duplicate (same product OR same domain as existing benefit)',
              '3. Determine if this product/service actually offers a student discount or free access',
              '4. Extract/generate the structured data. Use user-provided link/category if given, otherwise find them.',
              '',
              'RESPOND WITH ONLY JSON in this exact format:',
              '{',
              '  "valid": true or false,',
              '  "reason": "If not valid, explain why (e.g., no student program exists, unclear what product is meant, duplicate of existing benefit, etc.)",',
              '  "isDuplicate": true or false,',
              '  "duplicateOf": "Name of existing benefit if duplicate",',
              '  "benefit": {',
              '    "name": "Official Product/Service Name",',
              '    "category": "AI & Dev Tools | Cloud & Hosting | Learning | Design | Productivity | Lifestyle | Domains & Security | Other",',
              '    "description": "What students get - be specific about discounts, free tiers, duration (max 120 chars)",',
              '    "link": "Direct URL to the student signup/discount page",',
              '    "tags": ["Tag1", "Tag2", "Tag3"],',
              '    "repo": "owner/repo if open source, otherwise null"',
              '  }',
              '}',
              '',
              'IMPORTANT:',
              '- Accept casual submissions like "notion is free for students" - identify the product and fill in details',
              '- Only mark as valid if you are confident the product has a real student program',
              '- Mark as duplicate if product name is similar OR if URL domain matches an existing benefit',
              '- Use your knowledge to find the correct student discount URL if not provided',
              '- If user provided a link, validate it looks correct but prefer it over guessing',
              '- If user provided a category, use it',
              '- Be specific in the description (e.g., "Free Pro plan for 1 year" not "Student discount available")',
              '- Only mark as invalid if you truly cannot identify what product they mean'
            ].join('\n');

            let response;
            try {
              response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  messages: [{ role: 'user', content: prompt }],
                  temperature: 0.2
                })
              });
            } catch (e) {
              console.log('Fetch error:', e);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Failed to connect to AI service. Please try again later.'
              });
              return '';
            }

            if (!response.ok) {
              const error = await response.text();
              console.log('API error:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'AI service error. Please check the GH_MODELS_TOKEN secret is valid.'
              });
              return '';
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            console.log('AI response:', aiResponse);

            let result;
            try {
              const jsonStr = aiResponse.replace(/```json\n?|\n?```/g, '').trim();
              result = JSON.parse(jsonStr);
            } catch (e) {
              console.log('Failed to parse:', aiResponse);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Could not process the submission. Please provide more details about the student benefit.'
              });
              return '';
            }

            // Check for duplicate
            if (result.isDuplicate) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '**Duplicate detected:** This appears to be the same as **' + (result.duplicateOf || 'an existing benefit') + '** already in our directory.\n\nIf you believe this is different, please provide more details.'
              });
              return '';
            }

            if (!result.valid) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '**Cannot add this benefit:**\n\n' + result.reason + '\n\nPlease provide more details or submit a different benefit.'
              });
              return '';
            }

            const benefit = result.benefit;

            // Validate URL is reachable
            console.log('Validating URL:', benefit.link);
            try {
              const urlCheck = await fetch(benefit.link, {
                method: 'HEAD',
                redirect: 'follow',
                headers: { 'User-Agent': 'StudentBenefitsHub/1.0' }
              });
              if (!urlCheck.ok && urlCheck.status !== 405) {
                // 405 means HEAD not allowed, try GET
                const getCheck = await fetch(benefit.link, {
                  method: 'GET',
                  redirect: 'follow',
                  headers: { 'User-Agent': 'StudentBenefitsHub/1.0' }
                });
                if (!getCheck.ok) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: '**URL validation failed:** The link `' + benefit.link + '` returned status ' + getCheck.status + '.\n\nPlease verify the URL is correct and try again.'
                  });
                  return '';
                }
              }
            } catch (e) {
              console.log('URL check failed:', e);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '**URL validation failed:** Could not reach `' + benefit.link + '`.\n\nPlease verify the URL is correct and try again.'
              });
              return '';
            }

            const id = benefit.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

            // Check for exact ID match
            if (currentBenefits.some(b => b.id === id)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '**' + benefit.name + '** is already in our directory!'
              });
              return '';
            }

            // Add the new benefit to JSON
            const newBenefit = {
              id: id,
              name: benefit.name,
              category: benefit.category,
              description: benefit.description,
              link: benefit.link,
              tags: benefit.tags,
              popularity: 5
            };
            if (benefit.repo && benefit.repo !== 'null' && benefit.repo !== null) {
              newBenefit.repo = benefit.repo;
            }

            currentBenefits.push(newBenefit);
            fs.writeFileSync('src/data/benefits.json', JSON.stringify(currentBenefits, null, 2) + '\n');

            return JSON.stringify({
              name: benefit.name,
              id: id,
              issueNumber: issue.number,
              benefit: benefit
            });

      - name: Create Pull Request
        if: steps.process.outputs.result != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESULT: ${{ steps.process.outputs.result }}
        run: |
          NAME=$(echo "$RESULT" | jq -r '.name')
          ID=$(echo "$RESULT" | jq -r '.id')
          ISSUE=$(echo "$RESULT" | jq -r '.issueNumber')
          DESC=$(echo "$RESULT" | jq -r '.benefit.description')
          LINK=$(echo "$RESULT" | jq -r '.benefit.link')
          CATEGORY=$(echo "$RESULT" | jq -r '.benefit.category')

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="add-benefit-$ID"
          git checkout -b "$BRANCH"
          git add src/data/benefits.json
          git commit -m "Add benefit: $NAME"
          git push origin "$BRANCH"

          gh pr create \
            --title "Add benefit: $NAME" \
            --body "## $NAME

          **Category:** $CATEGORY
          **Link:** $LINK

          $DESC

          ---
          Closes #$ISSUE" \
            --base main \
            --head "$BRANCH"

      - name: Comment on issue
        if: steps.process.outputs.result != ''
        uses: actions/github-script@v7
        env:
          RESULT: ${{ steps.process.outputs.result }}
        with:
          script: |
            const data = JSON.parse(process.env.RESULT);
            const b = data.benefit;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: data.issueNumber,
              body: [
                'PR created to add **' + data.name + '**!',
                '',
                '| Field | Value |',
                '|-------|-------|',
                '| Category | ' + b.category + ' |',
                '| Link | ' + b.link + ' |',
                '| Tags | ' + b.tags.join(', ') + ' |',
                '',
                '> ' + b.description,
                '',
                'The PR will be reviewed and merged shortly.'
              ].join('\n')
            });
